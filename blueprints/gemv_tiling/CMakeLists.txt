# This file was auto-generated by aieblas on 2024-7-19 at 13:38

cmake_minimum_required(VERSION 3.22)

project(aieblas)

if (NOT EXISTS $ENV{XILINX_VITIS})
    message(FATAL_ERROR "Xilinx Vitis not found, make sure to source setup.sh")
endif ()

set(PLATFORM /opt/xilinx/platforms/xilinx_vck5000_gen4x8_qdma_2_202220_1/xilinx_vck5000_gen4x8_qdma_2_202220_1.xpfm)
set(PL_FREQ 500)

set(AIE_KERNELS
    aie/kernels/gemv.cpp
    aie/kernels/gemv.hpp
)
set(PL_KERNELS
    pl_kernels/gemv_mm2s_A.cpp
    pl_kernels/gemv_mm2s_scalar.cpp
    pl_kernels/gemv_mm2s_x.cpp
    pl_kernels/gemv_mm2s_y.cpp
    pl_kernels/gemv_s2mm.cpp
)

set(VPP "$ENV{XILINX_VITIS}/bin/v++")
set(AIECC "$ENV{XILINX_VITIS}/aietools/bin/aiecompiler")
set(AIESIM "$ENV{XILINX_VITIS}/aietools/bin/aiesimulator")
set(X86SIM "$ENV{XILINX_VITIS}/aietools/bin/x86simulator")

set(AIE_INCLUDE "-include=\"$ENV{XILINX_VITIS}/aietools/include\"" "-include=\"${CMAKE_CURRENT_SOURCE_DIR}/aie\"" "-include=\"${CMAKE_CURRENT_SOURCE_DIR}/data\"" "-include=\"${CMAKE_CURRENT_SOURCE_DIR}/aie/kernels\"")
set(AIE_FLAGS ${AIE_INCLUDE} --platform ${PLATFORM} --verbose=true --pl-freq=${PL_FREQ} -log-level=5 --output=graph.json)
set(VPP_FLAGS --platform ${PLATFORM} --save-temps --hls.jobs 8 --vivado.synth.jobs 8 --vivado.impl.jobs 8 -g -t hw --log_dir log --temp_dir tmp --report_dir report)

#######
# AIE #
#######

add_custom_target(
    xilinx
    COMMAND mkdir -p xilinx
    BYPRODUCTS xilinx
    VERBATIM
)

# HW / HW emu
add_custom_command(
    OUTPUT xilinx/libadf.a
    COMMAND ${AIECC} ${AIE_FLAGS} --output-archive=libadf.a -workdir=./Work --target=hw "${CMAKE_CURRENT_SOURCE_DIR}/aie/graph.cpp"
    MAIN_DEPENDENCY aie/graph.cpp
    DEPENDS xilinx aie/graph.hpp ${AIE_KERNELS}
    COMMENT "Building ADF graph for HW/HW-emulation xilinx/libadf_x86.a"
    WORKING_DIRECTORY xilinx
    VERBATIM
)

# SW emu
add_custom_command(
    OUTPUT xilinx/libadf_x86.a
    COMMAND ${AIECC} ${AIE_FLAGS} --output-archive=libadf_x86.a -workdir=./Work_sw --target=x86sim "${CMAKE_CURRENT_SOURCE_DIR}/aie/graph.cpp"
    MAIN_DEPENDENCY aie/graph.cpp
    DEPENDS xilinx aie/graph.h ${AIE_KERNELS}
    COMMENT "Building ADF graph for SW-emulation xilinx/libadf_x86.a"
    WORKING_DIRECTORY xilinx
    VERBATIM
)

######
# PL #
######

set(KERNEL_OBJECTS)
set(KERNEL_OBJECTS_PATH)
foreach(kernel ${PL_KERNELS})
    get_filename_component(name ${kernel} NAME_WE)

    add_custom_command(
        OUTPUT xilinx/${name}.xo
        COMMAND ${VPP} ${VPP_FLAGS} -c -k ${name} ${CMAKE_CURRENT_SOURCE_DIR}/${kernel} -o ${name}.xo
        MAIN_DEPENDENCY ${kernel}
        DEPENDS xilinx
        COMMENT "Building PL kernel xilinx/${name}.xo"
        WORKING_DIRECTORY xilinx
        VERBATIM
    )
    list(APPEND KERNEL_OBJECTS ${name}.xo)
    list(APPEND KERNEL_OBJECTS_PATH xilinx/${name}.xo)
endforeach()

##########
# XCLBIN #
##########

add_custom_command(
    OUTPUT xilinx/aieblas.xsa
    COMMAND ${VPP} ${VPP_FLAGS} -l ${KERNEL_OBJECTS} libadf.a --config ${CMAKE_CURRENT_SOURCE_DIR}/link.cfg -o aieblas.xsa
    DEPENDS xilinx xilinx/libadf.a ${KERNEL_OBJECTS_PATH} link.cfg
    COMMENT "Linking FPGA design xilinx/aieblas.xsa"
    WORKING_DIRECTORY xilinx
    VERBATIM
)

add_custom_command(
    OUTPUT xilinx/aieblas.xclbin
    COMMAND ${VPP} -p ${VPP_FLAGS} --package.boot_mode=ospi aieblas.xsa libadf.a -o aieblas.xclbin
    DEPENDS xilinx xilinx/aieblas.xsa xilinx/libadf.a
    COMMENT "Packaging FPGA design xilinx/aieblas.xclbin"
    WORKING_DIRECTORY xilinx
    VERBATIM
)


add_custom_target(aie
    COMMAND cp --preserve --update aieblas.xclbin ${CMAKE_BINARY_DIR}/aieblas.xclbin
    DEPENDS xilinx xilinx/aieblas.xclbin
    WORKING_DIRECTORY xilinx
    VERBATIM
)
